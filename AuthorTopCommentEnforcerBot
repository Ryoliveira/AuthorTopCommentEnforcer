import praw
import os
import time


class AuthorTopCommentBot:

    DEADLINE_MINUTES = 15

    def __init__(self):
        self.reddit = praw.Reddit(client_id=os.environ.get('CLIENT_ID'),
                                  client_secret=os.environ.get('CLIENT_SECRET'),
                                  user_agent="AuthorTopCommentBot v1.0",
                                  user_name=os.environ.get('USERNAME'),
                                  password=os.environ.get('PASSWORD'))
        self.submissions = []
        self.current_submission = None
        self.author_meets_requirement = None
        self.ids_to_ignore = []

    def get_submissions(self):
        new_submissions = self.reddit.subreddit("RyoliveiraTest").new(limit=10)
        for sub in new_submissions:
            minutes_since_creation = (time.time() - sub.created_utc) // 60
            if minutes_since_creation > self.DEADLINE_MINUTES:
                self.submissions.append(sub)
        # self.submissions = [sub for sub in new_submissions if ((time.time() - sub.created_utc) // 60) >= 15]

    def check_submission_for_author_comment(self):
        self.author_meets_requirement = False
        for comment in self.current_submission.comments:
            if comment.author == self.current_submission.author:
                if len(comment.body.replace("\s", "")) >= 40:
                    self.author_meets_requirement = True

    def process_decision(self):
        if self.author_meets_requirement:
            print("Submission meets requirement")
            self.write_id_to_file()
        else:
            print(f"Deleting submission - Title: {self.current_submission.title}, Author: {self.current_submission.author}")
            self.current_submission.mod.remove(mod_note="Submission did not meet required 40+ character top level comment by author")
            # TODO Send message to user with reason

    def get_ignore_ids(self):
        with open("submission_ids.txt", "r") as id_file:
            self.ids_to_ignore = [id for id in id_file.readlines()]

    def write_id_to_file(self):
        with open("submission_ids.txt", "a") as id_file:
            id_file.write(self.current_submission.id)

    def run_bot(self):
        self.get_ignore_ids()
        self.get_submissions()
        print(self.submissions)
        for submission in self.submissions:
            print(submission)
            if submission.id not in self.ids_to_ignore:
                self.current_submission = submission
                self.check_submission_for_author_comment()
                # self.process_decision()
                submission.reply("Hooplah")




if __name__ == '__main__':
    bot = AuthorTopCommentBot()
    bot.run_bot()

